/* 
Copyright (c) 2017 Deepak Khanal
All Rights Reserved
dkhanal AT gmail DOT com

Accuracy of Problem Code Assignment in MAUDE Database
*/

CREATE TABLE #COMPUTER_TECH_CAUSED_EVENTS (MDR_REPORT_KEY VARCHAR(50))
INSERT INTO #COMPUTER_TECH_CAUSED_EVENTS (MDR_REPORT_KEY)
	SELECT MDR_REPORT_KEY FROM [dbo].[VW_MDR_FOI_2007_THRU_2016]
	WHERE MDR_REPORT_KEY IN
	(879117, 997881, 1214830, 1220838, 1455879, 1571353, 1711538, 1819444, 1931462, 2066189, 2216497, 2275187, 2302306, 2314896, 2352682, 2359547, 2359639, 2407240, 2449480, 2506612, 2604215, 2798018, 2858634, 2886330, 2937454, 2994139, 3022001, 3031268, 3256955, 3320545, 3328297, 3341812, 3341882, 3448598, 3448716, 3448744, 3448745, 3448804, 3466409, 3742972, 3795936, 3823329, 3995715, 3996879, 4250870, 4291942, 4317222, 4489059, 4503014, 4670977, 4726159, 4726879, 4727612, 4808501, 4853057, 4860667, 4862826, 4885503, 4891913, 4973167, 4992244, 4998435, 5016637, 5040100, 5081947, 5087987, 5130337, 5144030, 5173671, 5234357, 5265912, 5290339, 5296801, 5304430, 5315750, 5367733, 5383602, 5394642, 5481181, 5493009, 5518232, 5563324, 5601982, 5611836, 5612260, 5621943, 5659693, 5667071, 5690889, 5703503, 5742098, 5820852, 5886040, 5895179, 5940750, 5954311, 5980174, 5992407, 6038935, 6066495, 6089282, 6132784)

SELECT *, (SELECT DESCRIPTION 
FROM [dbo].[VW_DEVICE_PROBLEM_CODES_CDRH_FDA_COMBINED] 
	WHERE DEVICE_PROBLEM_CODE = DP.DEVICE_PROBLEM_CODE) AS MAUDE_CAUSE,
	CASE WHEN EXISTS(SELECT DEVICE_PROBLEM_CODE 
		FROM [dbo].[VW_DEVICE_PROBLEM_CODES_COMPUTING] 
		WHERE DEVICE_PROBLEM_CODE = DP.DEVICE_PROBLEM_CODE) THEN 'Yes' ELSE 'No' 
	END AS MAUDE_CORRECT,
	CASE WHEN EXISTS(SELECT MDR_REPORT_KEY 
		FROM [dbo].[VW_MDR_FOI_2007_THRU_2016_COMPUTING_CAUSE_ML] 
		WHERE MDR_REPORT_KEY = DP.MDR_REPORT_KEY) THEN 'Yes' ELSE 'No' 
	END AS ML_CORRECT
FROM [dbo].[FOI_DEV_PROBLEM_ORIG] DP 
WHERE MDR_REPORT_KEY IN 
	(SELECT MDR_REPORT_KEY FROM #COMPUTER_TECH_CAUSED_EVENTS)

/* Merge computer-caused events that are missing causality classification in MAUDE */

UNION ALL
SELECT MDR_REPORT_KEY, NULL AS DEVICE_PROBLEM_CODE, NULL AS MAUDE_CAUSE, NULL AS MAUDE_CORRECT,
	CASE WHEN EXISTS(SELECT MDR_REPORT_KEY 
		FROM [dbo].[VW_MDR_FOI_2007_THRU_2016_COMPUTING_CAUSE_ML] 
		WHERE MDR_REPORT_KEY = CTE.MDR_REPORT_KEY) THEN 'Yes' ELSE 'No' 
	END AS ML_CORRECT
FROM #COMPUTER_TECH_CAUSED_EVENTS CTE
WHERE MDR_REPORT_KEY NOT IN 
	(SELECT MDR_REPORT_KEY FROM [FOI_DEV_PROBLEM_ORIG])

ORDER BY MDR_REPORT_KEY
DROP TABLE #COMPUTER_TECH_CAUSED_EVENTS


